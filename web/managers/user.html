<!-- User Manager Section -->
<div id="user-manager-section">
    <h2 class="section-title">User Manager</h2>
    
    <!-- User Selector -->
    <div class="form-group">
        <!--<label for="user-selector" class="form-label">Select User</label>-->
        <select id="user-selector" class="form-control">
            <option value="">-- Select a user --</option>
        </select>
    </div>
    
    <!-- User Editor -->
    <div id="user-editor" style="display: none;">
        <h3 class="text-primary">User Information</h3>
        <div class="card">
            <div class="card-body">
                <!-- Read-only fields -->
                <div class="form-group">
                    <label class="form-label">User ID (Read-only)</label>
                    <input type="text" id="user-id-display" class="form-control" readonly style="background-color: #f7fafc; cursor: not-allowed;">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Username (Read-only)</label>
                    <input type="text" id="username-display-editor" class="form-control" readonly style="background-color: #f7fafc; cursor: not-allowed;">
                </div>
                
                <!-- Editable fields -->
                <div class="form-group">
                    <label for="preferred-name" class="form-label">Preferred Name</label>
                    <input type="text" id="preferred-name" class="form-control" placeholder="">
                </div>
                
                <div class="form-group">
                    <label for="image-gen-limit" class="form-label">Image Generation Limit</label>
                    <input type="number" id="image-gen-limit" class="form-control" min="0" placeholder="5">
                </div>
                
                <div class="form-group">
                    <label for="research-limit" class="form-label">Deep Research Limit</label>
                    <input type="number" id="research-limit" class="form-control" min="0" placeholder="3">
                </div>
                
                <div class="form-group">
                    <label for="utc-offset" class="form-label">UTC Offset (hours)</label>
                    <input type="number" id="utc-offset" class="form-control" min="-12" max="14" placeholder="3">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Admin Chats</label>
                    <div id="admin-chats-container" style="border: 2px solid var(--border-color); border-radius: 0.375rem; padding: 1rem; max-height: 300px; overflow-y: auto;">
                        <!-- Checkboxes will be inserted here -->
                    </div>
                </div>
                
                <button id="update-user-btn" class="btn btn-primary">Update User</button>
            </div>
        </div>
    </div>
    
    <!-- Messages -->
    <div id="user-message" class="alert" style="display: none; margin-top: 1rem;"></div>
</div>

<script>
// User Manager - Exposed globally for dashboard integration
window.initUserManager = (function() {
    const API_BASE = '/api/managers/user';
    let currentUserId = null;
    let availableChats = [];
    let initialized = false;
    
    // Initialize
    async function init() {
        if (initialized) return; // Prevent double initialization
        
        await loadUsers();
        await loadAvailableChats();
        
        document.getElementById('user-selector').addEventListener('change', handleUserSelect);
        document.getElementById('update-user-btn').addEventListener('click', handleUpdateUser);
        
        initialized = true;
    }
    
    // Load all users
    async function loadUsers() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`${API_BASE}/users`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) throw new Error('Failed to load users');
            
            const users = await response.json();
            const selector = document.getElementById('user-selector');
            selector.innerHTML = '<option value="">-- Select a user --</option>';
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.user_id;
                option.textContent = `${user.username} (${user.user_id})`;
                selector.appendChild(option);
            });
        } catch (error) {
            showMessage('error', 'Failed to load users: ' + error.message);
        }
    }
    
    // Load available chats
    async function loadAvailableChats() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`${API_BASE}/chats`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) throw new Error('Failed to load chats');
            
            availableChats = await response.json();
        } catch (error) {
            showMessage('error', 'Failed to load chats: ' + error.message);
        }
    }
    
    // Handle user selection
    async function handleUserSelect(event) {
        const userId = event.target.value;
        
        if (!userId) {
            document.getElementById('user-editor').style.display = 'none';
            return;
        }
        
        currentUserId = userId;
        await loadUserDetails(userId);
        document.getElementById('user-editor').style.display = 'block';
    }
    
    // Load user details
    async function loadUserDetails(userId) {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`${API_BASE}/user/${userId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) throw new Error('Failed to load user details');
            
            const user = await response.json();
            
            // Fill in form
            document.getElementById('user-id-display').value = user.user_id;
            document.getElementById('username-display-editor').value = user.username;
            document.getElementById('preferred-name').value = user.preferred_name;
            document.getElementById('image-gen-limit').value = user.image_generation_limit;
            document.getElementById('research-limit').value = user.deep_research_limit;
            document.getElementById('utc-offset').value = user.utc_offset;
            
            // Render admin chats checkboxes
            renderAdminChats(user.admin_chats);
        } catch (error) {
            showMessage('error', 'Failed to load user details: ' + error.message);
        }
    }
    
    // Render admin chats checkboxes
    function renderAdminChats(selectedChats) {
        const container = document.getElementById('admin-chats-container');
        container.innerHTML = '';
        
        if (availableChats.length === 0) {
            container.innerHTML = '<p class="text-secondary">No chats available</p>';
            return;
        }
        
        availableChats.forEach(chat => {
            const div = document.createElement('div');
            div.style.marginBottom = '0.5rem';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `chat-${chat.id}`;
            checkbox.value = chat.id;
            checkbox.checked = selectedChats.includes(chat.id);
            checkbox.style.marginRight = '0.5rem';
            
            const label = document.createElement('label');
            label.htmlFor = `chat-${chat.id}`;
            label.textContent = chat.name;
            label.style.cursor = 'pointer';
            
            div.appendChild(checkbox);
            div.appendChild(label);
            container.appendChild(div);
        });
    }
    
    // Handle update user
    async function handleUpdateUser() {
        if (!currentUserId) return;
        
        // Collect admin chats
        const adminChats = [];
        document.querySelectorAll('#admin-chats-container input[type="checkbox"]:checked').forEach(checkbox => {
            adminChats.push(checkbox.value);
        });
        
        const data = {
            user_id: currentUserId,
            preferred_name: document.getElementById('preferred-name').value,
            image_generation_limit: parseInt(document.getElementById('image-gen-limit').value),
            deep_research_limit: parseInt(document.getElementById('research-limit').value),
            utc_offset: parseInt(document.getElementById('utc-offset').value),
            admin_chats: adminChats
        };
        
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`${API_BASE}/user`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) throw new Error('Failed to update user');
            
            const result = await response.json();
            showMessage('success', result.message, document.getElementById('update-user-btn'));
            await loadUsers(); // Refresh user list
        } catch (error) {
            showMessage('error', 'Failed to update user: ' + error.message, document.getElementById('update-user-btn'));
        }
    }
    
    // Show message
    function showMessage(type, text, targetElement = null) {
        const messageDiv = document.getElementById('user-message');
        messageDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'}`;
        messageDiv.textContent = text;
        messageDiv.style.display = 'block';
        
        // Position the message near the triggering element if provided
        if (targetElement) {
            // Find the closest card container or use the element's parent
            const container = targetElement.closest('.card') || targetElement.closest('.card-body') || targetElement.parentElement;
            if (container && container.parentElement) {
                // Insert the message after the container
                container.parentElement.insertBefore(messageDiv, container.nextSibling);
            }
        }
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }
    
    // Return the init function for external initialization
    return init;
})();
</script>

<style>
#admin-chats-container {
    background-color: var(--background-white);
}

#admin-chats-container label {
    user-select: none;
}
</style>
