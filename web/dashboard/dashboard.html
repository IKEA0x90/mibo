<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mibo Admin - Dashboard</title>
    <link rel="stylesheet" href="/static/web.css">
    <style>
        body {
            background: linear-gradient(135deg, var(--primary-red), var(--dark-red));
            min-height: 100vh;
            margin: 0;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
        }
        
        .header h1 {
            color: var(--primary-red);
            margin: 0;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logout-btn {
            background: var(--secondary-red);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .logout-btn:hover {
            background: var(--dark-red);
        }
        
        .nav-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background: white;
            padding: 1rem;
            border-radius: 8px;
        }
        
        .nav-btn {
            flex: 1;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 500;
            background: white;
            color: var(--primary-red);
            border: 2px solid var(--primary-red);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background: var(--light-red);
        }
        
        .nav-btn.active {
            background: var(--primary-red);
            color: white;
        }
        
        .main-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }
        
        .manager-section {
            display: none;
        }
        
        .manager-section.active {
            display: block;
        }
        
        .section-title {
            color: var(--primary-red);
            margin: 0 0 1.5rem 0;
            font-size: 1.75rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="header">
            <h1>Mibo Admin Dashboard</h1>
            <div class="user-info">
                <span id="username-display">Loading...</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="nav-buttons">
            <button class="nav-btn active" onclick="showSection('chat', this)">Chat Manager</button>
            <button class="nav-btn" onclick="showSection('reference', this)">Reference Manager</button>
            <button class="nav-btn" onclick="showSection('user', this)">User Manager</button>
        </div>
        
        <!-- Main Content -->
        <div class="main-section">
            <!-- Chat Manager -->
            <div id="chat-section" class="manager-section active">
                <!-- Content will be loaded from chat.html -->
            </div>
            
            <!-- Reference Manager -->
            <div id="reference-section" class="manager-section">
                <!-- Content will be loaded from reference.html -->
            </div>
            
            <!-- User Manager -->
            <div id="user-section" class="manager-section">
                <!-- Content will be loaded from user.html -->
            </div>
        </div>
    </div>
    
    <script>
        // Global manager initialization functions
        let chatManagerInitialized = false;
        let referenceManagerInitialized = false;
        let userManagerInitialized = false;
        
        // Check authentication on page load
        async function checkAuth() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                window.location.href = '/login';
                return;
            }
            
            try {
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Token invalid');
                }
                
                const data = await response.json();
                document.getElementById('username-display').textContent = data.user.username;
                
                // Load manager sections
                await loadManagerSections();
                
                // Small delay to ensure scripts are fully executed
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Initialize the first visible section (chat)
                await initializeSection('chat');
            } catch (error) {
                localStorage.removeItem('access_token');
                window.location.href = '/login';
            }
        }
        
        // Load manager HTML sections
        async function loadManagerSections() {
            try {
                // Load chat manager
                const chatResponse = await fetch('/static/managers/chat.html');
                const chatHtml = await chatResponse.text();
                document.getElementById('chat-section').innerHTML = chatHtml;
                
                // Load reference manager
                const refResponse = await fetch('/static/managers/reference.html');
                const refHtml = await refResponse.text();
                document.getElementById('reference-section').innerHTML = refHtml;
                
                // Load user manager
                const userResponse = await fetch('/static/managers/user.html');
                const userHtml = await userResponse.text();
                document.getElementById('user-section').innerHTML = userHtml;
                
                // Execute scripts in loaded HTML (this makes functions available globally)
                await executeScripts('chat-section');
                await executeScripts('reference-section');
                await executeScripts('user-section');
            } catch (error) {
                console.error('Failed to load manager sections:', error);
            }
        }
        
        // Execute scripts in loaded HTML
        async function executeScripts(containerId) {
            console.log(`Executing scripts for ${containerId}...`);
            const container = document.getElementById(containerId);
            const scripts = container.querySelectorAll('script');
            
            console.log(`Found ${scripts.length} scripts in ${containerId}`);
            
            for (let script of scripts) {
                const newScript = document.createElement('script');
                
                if (script.src) {
                    // For external scripts
                    console.log(`Loading external script: ${script.src}`);
                    newScript.src = script.src;
                    // Wait for external script to load
                    await new Promise((resolve, reject) => {
                        newScript.onload = () => {
                            console.log(`External script loaded: ${script.src}`);
                            resolve();
                        };
                        newScript.onerror = (err) => {
                            console.error(`Failed to load external script: ${script.src}`, err);
                            reject(err);
                        };
                        document.body.appendChild(newScript);
                    });
                } else {
                    // For inline scripts, execute immediately
                    console.log(`Executing inline script in ${containerId} (${script.textContent.length} chars)`);
                    newScript.textContent = script.textContent;
                    document.body.appendChild(newScript);
                }
                
                // Remove old script
                script.remove();
            }
            
            console.log(`Finished executing scripts for ${containerId}`);
        }
        
        // Initialize a specific section
        async function initializeSection(section) {
            console.log(`Attempting to initialize ${section} manager...`);
            
            try {
                switch(section) {
                    case 'chat':
                        if (!chatManagerInitialized && typeof window.initChatManager === 'function') {
                            console.log('Initializing chat manager...');
                            await window.initChatManager();
                            chatManagerInitialized = true;
                            console.log('Chat manager initialized successfully');
                        } else if (chatManagerInitialized) {
                            console.log('Chat manager already initialized');
                        } else {
                            console.error('window.initChatManager is not a function:', typeof window.initChatManager);
                        }
                        break;
                    case 'reference':
                        if (!referenceManagerInitialized && typeof window.initReferenceManager === 'function') {
                            console.log('Initializing reference manager...');
                            await window.initReferenceManager();
                            referenceManagerInitialized = true;
                            console.log('Reference manager initialized successfully');
                        } else if (referenceManagerInitialized) {
                            console.log('Reference manager already initialized');
                        } else {
                            console.error('window.initReferenceManager is not a function:', typeof window.initReferenceManager);
                        }
                        break;
                    case 'user':
                        if (!userManagerInitialized && typeof window.initUserManager === 'function') {
                            console.log('Initializing user manager...');
                            await window.initUserManager();
                            userManagerInitialized = true;
                            console.log('User manager initialized successfully');
                        } else if (userManagerInitialized) {
                            console.log('User manager already initialized');
                        } else {
                            console.error('window.initUserManager is not a function:', typeof window.initUserManager);
                        }
                        break;
                }
            } catch (error) {
                console.error(`Failed to initialize ${section} manager:`, error);
            }
        }
        
        // Show section
        async function showSection(section, buttonElement) {
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the button that was clicked
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else {
                // Fallback: find button by section name
                const buttons = document.querySelectorAll('.nav-btn');
                buttons.forEach(btn => {
                    if (btn.textContent.toLowerCase().includes(section)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Hide all sections
            document.querySelectorAll('.manager-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(section + '-section').classList.add('active');
            
            // Initialize the section if needed
            await initializeSection(section);
        }
        
        // Logout
        async function logout() {
            const token = localStorage.getItem('access_token');
            
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            
            localStorage.removeItem('access_token');
            window.location.href = '/login';
        }
        
        // Initialize on page load
        checkAuth();
    </script>
</body>
</html>